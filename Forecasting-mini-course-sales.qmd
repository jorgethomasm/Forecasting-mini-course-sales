---
title: "Forecasting Sales Time-Series with XGBoost"
subtitle: "Sale Products: Kaggle's mini-courses." # only for html output
author: "Jorge A. Thomas"
date: "`r Sys.Date()`"
format:    
    html:
      self-contained: true
      code-fold: true
      df-print: tibble
      code-summary: "Show the code"
      grid: 
        margin-width: 350px
execute: 
  echo: fenced
reference-location: margin # margin
citation-location: document
bibliography: minicoursesales.bib
# Template: https://quarto-dev.github.io/quarto-gallery/page-layout/tufte.html
---

## Introduction

Here I present my solution to Kaggle's competition **Forecasting Mini-Course Sales** of 2023. 

Playground Series - Season 3, Episode 19.

Using the synthetic-generated dataset [@playground-series-s3e19], you'll follow my workflow developing pipelines on the ETL phase of the Data Science cycle using the R programming language [@R-base], as well as a tidy approach to forecasting.

```{r}
#| label: setup
#| message: false
#| echo: false

library(tidyverse) # ETL and EDA tools
library(tictoc) # measure runtime
library(httpgd)

source("./libs/jthomfuncs.r")
theme_set(jthomggtheme)
```



```{r}
#| label: Load Data
#| warning: false

sales_train_raw <- read_csv("./data/raw/train.csv") # Train, validattion and test dataset
print("Dimensions of training dataset")
dim(sales_train_raw)

sales_test_raw <- read_csv("./data/raw/test.csv")  # Features for submission dataset
print("Dimensions of test dataset containing only Feats.")
dim(sales_test_raw) 

# Add Target column with NA so both DFs can be concatenated:.id
sales_test_raw <- 
  sales_test_raw |> 
    mutate(num_sold = NA)

# Binding and adding identifier column "dataset" 
sales_all <- 
  bind_rows(list(train = sales_train_raw, test = sales_test_raw), .id = "dataset")

print("Available variables:")
names(sales_all)

```

### Count NAs

```{r}
#| label: Counting NAs
#| code-fold: false

sales_all |>
  select(-num_sold) |>
  count_na() |>
  knitr::kable(caption = "Courses Sales dataset")

```

### Adding temporal features

```{r}

#' make a function of this!
#' expand_temporal_feats(datetime_colname)

sales_all <- sales_all |>
  mutate(year = year(date)) |>
  mutate(quarter = ceiling(month(date)/3)) |>
  mutate(month = month(date)) |>
  mutate(month_day = mday(date)) |>
  mutate(dow = wday(date, label = TRUE, abbr = FALSE)) |>
  mutate(isweekend = weekdays(date)  %in% c("Saturday", "Sunday"))

# Delete "Using LLMS to " from product col

sales_all <- sales_all |>
  mutate(product = str_remove(product, "Using LLMs to ")) 


# Establish categorical variables

sales_all <- sales_all |>
  mutate(country = factor(country)) |>
  mutate(store = factor(store)) |>
  mutate(product = factor(product)) 

# cat_feats <- c("country", "store", "product")
# cat_feats <- sales_all |>
#   mutate(across(all_of(cat_feats), ~ factor(.x, ordered = FALSE)))

```

### Visualise Total Sales

```{r}

# country_colours = c("Argentina" = "#6CACE4", "Canada" = "#D80621", "Estonia" =  "#0072CE", "Japan" = "#BC002D", "Spain" = "#F1BF00")
country_colours = c("#6CACE4", "#D80621", "#0072CE", "#BC002D", "#F1BF00")
names(country_colours) <- levels(sales_all$country)

sales_all |> 
  filter(dataset == "train") |>
  group_by(country) |>
  summarise(total_sales = sum(num_sold)) |>
  ggplot(aes(y = fct_reorder(country, total_sales), x = total_sales)) + 
  geom_col(aes(fill = country)) +
  geom_text(aes(label = total_sales), size = 6) +
  labs(y = "Country") + 
  scale_fill_manual(values = country_colours) +
  theme(legend.position = "none", axis.title.y = element_text(angle = 90))


# Total Sales TS
sales_all |> 
  filter(dataset == "train") |>
  group_by(date) |>
  summarise(total_sales = sum(num_sold)) |>
  mutate(year = as.factor(year(date))) |>
  ggplot(aes(x = date, y = total_sales)) +
  labs(x = "", y = "Total\nSales") +
  geom_line(colour = "red") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") + 
  scale_y_continuous(breaks = seq(0, 24000, 2000)) + 
  facet_wrap(~year, scales = "free_x", nrow = 1) +    
  theme(axis.text.x  = element_text(angle = 90, size = 10) )
  

# "%b %d" "%a %d %m %R"

# sales_all |> 
#   filter(dataset == "train") |>
#   group_by(date, country) |>
#   summarise(total_sales = sum(num_sold)) |>
#   mutate(year = as.factor(year(date))) |>

#   ggplot(aes(x = date, y = total_sales)) +
#   labs(x = "", y = "Total\nSales") +
#   geom_line() +
#   scale_x_date(date_breaks = "1 month", date_labels = "%b") + 
#   scale_y_continuous(breaks = seq(0, 8000, 1000)) + 
#   facet_grid(country ~ year, scales = "free_x") + 
#   # scale_fill_manual(values = country_colours) +
#   theme(axis.text.x  = element_text(angle = 90, size = 10) )


sales_all |> 
  filter(dataset == "train") |>
  group_by(date, country) |>
  summarise(total_sales = sum(num_sold)) |>
  pivot_wider(names_from = country, values_from = total_sales) |>
  
  ggplot(aes(x = date)) +
  labs(x = "", y = "Total\nSales") +
  geom_line(aes(y = Argentina), colour = "#6CACE4") +
  geom_line(aes(y = Canada), colour = "#D80621") +
  geom_line(aes(y = Estonia), colour = "#0072CE") +
  geom_line(aes(y = Japan), colour = "#BC002D") +
  geom_line(aes(y = Spain), colour = "#F1BF00") +
  scale_x_date(date_breaks = "1 years", date_minor_breaks = "6 months", date_labels = "%Y") + 
  scale_y_continuous(breaks = seq(0, 8000, 1000)) 
 

```

### Add Pandemic Flag

One can see clearly the pandemic effect starting on March 2020. A feature flag should be added.

```{r}

```

